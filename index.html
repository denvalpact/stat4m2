<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Match Statistics Form</title>

    <!-- Add Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpUB0SDEYVhy8J9LSHY4UoQmbXx3F6adU",
            authDomain: "handballmatchstatisticscounter.firebaseapp.com",
            projectId: "handballmatchstatisticscounter",
            storageBucket: "handballmatchstatisticscounter.firebasestorage.app",
            messagingSenderId: "801047095180",
            appId: "1:801047095180:web:97ed51c9b2f1d025b158a9",
            measurementId: "G-92CEXGX2N5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase services available globally
        window.db = db;
        window.auth = auth;
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            font-size: 10px;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .form-container {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .match-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .team-info {
            display: flex;
            gap: 10px;
        }
        
        .columns-container {
            display: flex;
            width: 100%;
            gap: 10px;
        }
        
        .team-column {
            width: 50%;
            box-sizing: border-box;
        }
        
        .team-a-column {
            padding-right: 5px;
        }
        
        .team-b-column {
            padding-left: 5px;
        }
        
        .stat-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 10px;
        }
        
        .stat-table, .stat-table th, .stat-table td {
            border: 1px solid black;
        }
        
        .stat-table th, .stat-table td {
            padding: 3px;
            text-align: center;
            height: 20px;
        }
        
        .stat-table td {
            cursor: pointer;
        }
        
        .small-col {
            width: 20px;
        }
        
        .medium-col {
            width: 25px;
        }
        
        .name-col {
            width: 70px;
        }
        
        .team-a {
            background-color: #e6f7ff;
        }
        
        .team-b {
            background-color: #fff2e6;
        }
        
        .controls {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #ddd;
        }
        
        select, input, button {
            font-size: 10px;
            padding: 3px;
            margin-right: 5px;
        }
        
        button {
            cursor: pointer;
        }
        
        .team-title {
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .player-controls {
            display: flex;
            gap: 5px;
            margin-top: 2px;
        }
        
        .player-controls button {
            padding: 1px 3px;
            font-size: 8px;
        }
        
        .active-period {
            background-color: #ffeb3b;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .suspension-active {
            background-color: #ffcdd2;
        }
        
        .red-card {
            background-color: #ff0000;
            color: white;
            font-weight: bold;
        }
        
        .yellow-card {
            background-color: #ffff00;
            font-weight: bold;
        }
        
        .timeout-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
        }
        
        .timeout-team {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .timeout-count {
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .timeout-button {
            padding: 2px 5px;
            font-size: 9px;
        }
        
        .timeout-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .timeout-active {
            background-color: #ffeb3b;
            font-weight: bold;
        }
        
        .timeout-timer {
            margin-left: 5px;
            font-weight: bold;
        }
        
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .quick-actions {
            display: flex;
            gap: 5px;
        }

        .quick-action-btn {
            padding: 2px 5px;
            font-size: 9px;
            cursor: pointer;
        }
        .context-menu button {
            display: block;
            width: 100%;
            padding: 5px 10px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .context-menu button:hover {
            background-color: #f0f0f0;
        }
        
        .add-player-form {
            margin-top: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }
        
        .add-player-form input {
            margin-right: 5px;
            width: 60px;
        }
        
        .add-player-form button {
            padding: 3px 5px;
        }
        
        .empty-player {
            color: #999;
            font-style: italic;
        }
        
        .time-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .auth-controls {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            text-align: center;
        }

        .auth-controls input {
            margin: 0 5px;
            padding: 5px;
        }

        #auth-status {
            font-weight: bold;
            margin-bottom: 5px;
        }

        #user-email {
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .time-config {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            background-color: #f5f5f5;
        }
        
        .time-config label {
            margin-right: 5px;
        }
        
        .time-config input {
            width: 40px;
            text-align: center;
        }
        
        .officials-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        
        .officials-table, .officials-table th, .officials-table td {
            border: 1px solid black;
        }
        
        .officials-table th, .officials-table td {
            padding: 3px;
            text-align: center;
        }
        
        .editable-referee {
            cursor: pointer;
            border-bottom: 1px dashed #999;
        }
        
        .period-score {
            font-weight: bold;
            margin-left: 5px;
        }
        
        .suspension-timer {
            font-size: 8px;
            color: #d32f2f;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="header">ENHANCED MATCH STATISTICS</div>
        
        <div class="match-info">
            <div class="team-info">
                <div><strong>Team A</strong> vs <strong>Team B</strong></div>
                <div><strong>Date:</strong> <span id="match-date">2023-11-15</span></div>
            </div>
            <div><strong>Match No.:</strong> <span id="match-number">10765</span></div>
        </div>
        
        <!-- Time Configuration -->
        <div class="time-config">
            <strong>Match Duration:</strong>
            <label>1H: <input type="number" id="period-1h-duration" min="1" value="30"> min</label>
            <label>2H: <input type="number" id="period-2h-duration" min="1" value="30"> min</label>
            <label>ET1: <input type="number" id="period-et1-duration" min="1" value="5"> min</label>
            <label>ET2: <input type="number" id="period-et2-duration" min="1" value="5"> min</label>
            <button id="apply-time-config">Apply</button>
        </div>
        
        <!-- Timeout Controls -->
        <div class="timeout-controls">
            <div class="timeout-team">
                <span>Team A Timeouts:</span>
                <span id="timeout-count-a" class="timeout-count">3</span>
                <button id="timeout-button-a" class="timeout-button">Call Timeout</button>
                <span id="timeout-timer-a" class="timeout-timer"></span>
            </div>
            <div class="timeout-team">
                <span>Team B Timeouts:</span>
                <span id="timeout-count-b" class="timeout-count">3</span>
                <button id="timeout-button-b" class="timeout-button">Call Timeout</button>
                <span id="timeout-timer-b" class="timeout-timer"></span>
            </div>
        </div>
        
        <div class="time-markers">
            <div id="period-1H">1st Half (<span class="period-duration">30</span>') <span class="period-score" id="period-1h-score"></span></div>
            <div id="period-2H">2nd Half (<span class="period-duration">30</span>') <span class="period-score" id="period-2h-score"></span></div>
            <div id="period-ET1">1st Extra Time (<span class="period-duration">5</span>') <span class="period-score" id="period-et1-score"></span></div>
            <div id="period-ET2">2nd Extra Time (<span class="period-duration">5</span>') <span class="period-score" id="period-et2-score"></span></div>
        </div>
        
        <div class="controls">
            <div class="time-controls">
                <strong>Time:</strong> 
                <span id="match-time">00:00</span>
                <span id="current-period" class="active-period">1H</span>
                <button id="pause-btn">⏸ Pause</button>
                <button id="reset-time-btn">↻ Reset Time</button>
            </div>
            <button id="toggle-suspension" class="suspension-active">2' Suspension Active</button>
            <div class="quick-actions">
                <button id="undo-btn" class="quick-action-btn" title="Undo last action">↩ Undo</button>
                <button id="redo-btn" class="quick-action-btn" title="Redo last action">↪ Redo</button>
            </div>
        </div>
        
        <!-- Two Column Layout -->
        <div class="columns-container">
            <!-- Team A Column (Left) -->
            <div class="team-column team-a-column">
                <div class="team-title">TEAM A</div>
                
                <!-- Add Player Form for Team A -->
                <div class="add-player-form">
                    <strong>Add Player:</strong>
                    <input type="text" id="player-name-a" placeholder="Name">
                    <input type="number" id="player-number-a" placeholder="Number" min="1" max="99">
                    <button id="add-player-a">Add to Team A</button>
                </div>
                
                <table class="stat-table" id="stats-table-a">
                    <thead>
                        <tr>
                            <th class="small-col">No.</th>
                            <th class="name-col">Name</th>
                            <th class="small-col">Shirt</th>
                            <th class="small-col">Goals</th>
                            <th class="small-col">Assists</th>
                            <th class="small-col">Saves</th>
                            <th class="small-col">2'</th>
                            <th class="small-col">Yellow</th>
                            <th class="small-col">Red</th>
                            <th class="small-col">Steals</th>
                            <th class="small-col">Blocks</th>
                            <th class="small-col">Turnovers</th>
                        </tr>
                    </thead>
                    <tbody id="stats-body-a">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
                
                <!-- Team Officials for Team A -->
                <table class="officials-table">
                    <thead>
                        <tr>
                            <th colspan="3">Team A Officials</th>
                        </tr>
                        <tr>
                            <th>Role</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="officials-body-a">
                        <tr>
                            <td>Head Coach</td>
                            <td class="official-name" contenteditable="true">Coach A1</td>
                            <td><button class="remove-official" data-team="A" data-index="0">Remove</button></td>
                        </tr>
                        <tr>
                            <td>Assistant Coach</td>
                            <td class="official-name" contenteditable="true">Coach A2</td>
                            <td><button class="remove-official" data-team="A" data-index="1">Remove</button></td>
                        </tr>
                        <tr>
                            <td>Team Manager</td>
                            <td class="official-name" contenteditable="true">Manager A</td>
                            <td><button class="remove-official" data-team="A" data-index="2">Remove</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Team B Column (Right) -->
            <div class="team-column team-b-column">
                <div class="team-title">TEAM B</div>
                
                <!-- Add Player Form for Team B -->
                <div class="add-player-form">
                    <strong>Add Player:</strong>
                    <input type="text" id="player-name-b" placeholder="Name">
                    <input type="number" id="player-number-b" placeholder="Number" min="1" max="99">
                    <button id="add-player-b">Add to Team B</button>
                </div>
                
                <table class="stat-table" id="stats-table-b">
                    <thead>
                        <tr>
                            <th class="small-col">No.</th>
                            <th class="name-col">Name</th>
                            <th class="small-col">Shirt</th>
                            <th class="small-col">Goals</th>
                            <th class="small-col">Assists</th>
                            <th class="small-col">Saves</th>
                            <th class="small-col">2'</th>
                            <th class="small-col">Yellow</th>
                            <th class="small-col">Red</th>
                            <th class="small-col">Steals</th>
                            <th class="small-col">Blocks</th>
                            <th class="small-col">Turnovers</th>
                        </tr>
                    </thead>
                    <tbody id="stats-body-b">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
                
                <!-- Team Officials for Team B -->
                <table class="officials-table">
                    <thead>
                        <tr>
                            <th colspan="3">Team B Officials</th>
                        </tr>
                        <tr>
                            <th>Role</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="officials-body-b">
                        <tr>
                            <td>Head Coach</td>
                            <td class="official-name" contenteditable="true">Coach B1</td>
                            <td><button class="remove-official" data-team="B" data-index="0">Remove</button></td>
                        </tr>
                        <tr>
                            <td>Assistant Coach</td>
                            <td class="official-name" contenteditable="true">Coach B2</td>
                            <td><button class="remove-official" data-team="B" data-index="1">Remove</button></td>
                        </tr>
                        <tr>
                            <td>Team Manager</td>
                            <td class="official-name" contenteditable="true">Manager B</td>
                            <td><button class="remove-official" data-team="B" data-index="2">Remove</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="auth-controls">
            <div id="auth-status">Offline Mode</div>
            <div id="user-email" style="display: none;"></div>
            <button id="toggle-online-btn">Go Online</button>
            <div id="login-form" style="display: none; margin-top: 5px;">
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-password" placeholder="Password">
                <button id="login-btn">Login</button>
                <button id="logout-btn">Logout</button>
            </div>
        </div>
        
        <div class="match-info" style="margin-top: 10px;">
            <div>
                <strong>Referees:</strong> 
                <span id="referee1" class="editable-referee">John Smith</span>, 
                <span id="referee2" class="editable-referee">Michael Johnson</span>
            </div>
            <div>
                <strong>City:</strong> <span id="city">Berlin</span>
            </div>
        </div>
    </div>

    <div class="context-menu" id="context-menu">
        <button id="increment-btn">Increment (+1)</button>
        <button id="decrement-btn">Decrement (-1)</button>
        <button id="reset-btn">Reset (0)</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize empty player data
        const players = {
            A: Array(16).fill().map((_, index) => ({
                id: index + 1,
                name: "",
                number: "",
                goals: 0,
                assists: 0,
                saves: 0,
                twoMinutes: 0,
                yellowCards: 0,
                redCard: false,
                steals: 0,
                blocks: 0,
                turnovers: 0,
                isEmpty: true,
                suspensionEndTime: 0,
                isSuspended: false
            })),
            B: Array(16).fill().map((_, index) => ({
                id: index + 1,
                name: "",
                number: "",
                goals: 0,
                assists: 0,
                saves: 0,
                twoMinutes: 0,
                yellowCards: 0,
                redCard: false,
                steals: 0,
                blocks: 0,
                turnovers: 0,
                isEmpty: true,
                suspensionEndTime: 0,
                isSuspended: false
            }))
        };

        // Game state
        let gameState = {
            seconds: 0,
            period: '1H',
            isTwoMinuteSuspension: false,
            suspensionTeam: null,
            suspensionEndTime: 0,
            timeouts: {
                A: 3,
                B: 3
            },
            isTimeoutActive: false,
            timeoutTeam: null,
            timeoutStartTime: 0,
            timeoutEndTime: 0,
            timeoutTimer: null,
            isPaused: false,
            timerInterval: null,
            periodDurations: {
                '1H': 30 * 60, // 30 minutes in seconds
                '2H': 30 * 60,
                'ET1': 5 * 60,
                'ET2': 5 * 60
            },
            periodScores: {
                '1H': { A: 0, B: 0 },
                '2H': { A: 0, B: 0 },
                'ET1': { A: 0, B: 0 },
                'ET2': { A: 0, B: 0 }
            },
            totalScores: { A: 0, B: 0 },
            isOnline: false,
            matchId: generateMatchId(),
            lastSaved: null
        };

        // Context menu state
        let contextMenu = {
            element: null,
            currentCell: null,
            currentPlayer: null,
            currentStat: null
        };

        // Initialize tables with empty player data
        function initializeTables() {
            renderTeamTable('A');
            renderTeamTable('B');
            setupCellClickHandlers();
            setupEditableReferees();
            setupOfficialControls();
        }

        // Render team table
        function renderTeamTable(team) {
            const tbody = document.getElementById(`stats-body-${team.toLowerCase()}`);
            tbody.innerHTML = '';
            
            players[team].forEach((player, index) => {
                const tr = document.createElement('tr');
                if (player.redCard) {
                    tr.classList.add('red-card');
                }
                
                if (player.isEmpty) {
                    tr.classList.add('empty-player');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td colspan="11">Empty slot - add player</td>
                    `;
                } else {
                    // Add suspension timer if player is suspended
                    const suspensionTimer = player.isSuspended ? 
                        `<div class="suspension-timer">(${formatTime(player.suspensionEndTime - gameState.seconds)})</div>` : '';
                    
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td>${player.number}</td>
                        <td class="stat-cell" data-stat="goals" data-player-id="${player.id}" data-team="${team}">${player.goals}</td>
                        <td class="stat-cell" data-stat="assists" data-player-id="${player.id}" data-team="${team}">${player.assists}</td>
                        <td class="stat-cell" data-stat="saves" data-player-id="${player.id}" data-team="${team}">${player.saves}</td>
                        <td class="stat-cell" data-stat="twoMinutes" data-player-id="${player.id}" data-team="${team}">${player.twoMinutes}${suspensionTimer}</td>
                        <td class="stat-cell" data-stat="yellowCards" data-player-id="${player.id}" data-team="${team}" ${player.yellowCards > 0 ? 'class="yellow-card"' : ''}>${player.yellowCards}</td>
                        <td class="stat-cell" data-stat="redCard" data-player-id="${player.id}" data-team="${team}">${player.redCard ? 'X' : ''}</td>
                        <td class="stat-cell" data-stat="steals" data-player-id="${player.id}" data-team="${team}">${player.steals}</td>
                        <td class="stat-cell" data-stat="blocks" data-player-id="${player.id}" data-team="${team}">${player.blocks}</td>
                        <td class="stat-cell" data-stat="turnovers" data-player-id="${player.id}" data-team="${team}">${player.turnovers}</td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        // Firebase data operations
        const firebaseService = {
            // Save match data to Firestore
            saveMatchData: async function(matchId, data) {
                try {
                    await db.collection('matches').doc(matchId).set(data, { merge: true });
                    console.log('Match data saved successfully');
                    return true;
                } catch (error) {
                    console.error('Error saving match data:', error);
                    return false;
                }
            },

            // Load match data from Firestore
            loadMatchData: async function(matchId) {
                try {
                    const doc = await db.collection('matches').doc(matchId).get();
                    if (doc.exists) {
                        return doc.data();
                    }
                    return null;
                } catch (error) {
                    console.error('Error loading match data:', error);
                    return null;
                }
            },

            // Get current user
            getCurrentUser: function() {
                return new Promise((resolve) => {
                    const unsubscribe = auth.onAuthStateChanged(user => {
                        unsubscribe();
                        resolve(user);
                    });
                });
            },

            // Sign in with email/password
            signIn: async function(email, password) {
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    return true;
                } catch (error) {
                    console.error('Sign in error:', error);
                    return false;
                }
            },

            // Sign out
            signOut: async function() {
                try {
                    await auth.signOut();
                    return true;
                } catch (error) {
                    console.error('Sign out error:', error);
                    return false;
                }
            }
        };

        function generateMatchId() {
            const date = new Date();
            return `match-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}-${Math.random().toString(36).substr(2, 6)}`;
        }

        async function saveGameState() {
            if (!gameState.isOnline) return;
            
            const dataToSave = {
                players: players,
                gameState: {
                    seconds: gameState.seconds,
                    period: gameState.period,
                    timeouts: gameState.timeouts,
                    periodScores: gameState.periodScores,
                    totalScores: gameState.totalScores
                },
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const success = await firebaseService.saveMatchData(gameState.matchId, dataToSave);
            if (success) {
                gameState.lastSaved = new Date();
                console.log('Game state saved to Firebase');
            }
        }

        async function loadGameState() {
            const data = await firebaseService.loadMatchData(gameState.matchId);
            if (data) {
                // Update players
                if (data.players) {
                    players.A = data.players.A || players.A;
                    players.B = data.players.B || players.B;
                    renderTeamTable('A');
                    renderTeamTable('B');
                    setupCellClickHandlers();
                }
                
                // Update game state
                if (data.gameState) {
                    gameState.seconds = data.gameState.seconds || gameState.seconds;
                    gameState.period = data.gameState.period || gameState.period;
                    gameState.timeouts = data.gameState.timeouts || gameState.timeouts;
                    gameState.periodScores = data.gameState.periodScores || gameState.periodScores;
                    gameState.totalScores = data.gameState.totalScores || gameState.totalScores;
                    
                    // Update UI
                    updateTimeDisplay();
                    updatePeriodHighlight();
                    updatePeriodScoresDisplay();
                    
                    // Update timeout counts
                    document.getElementById('timeout-count-a').textContent = gameState.timeouts.A;
                    document.getElementById('timeout-count-b').textContent = gameState.timeouts.B;
                }
                
                console.log('Game state loaded from Firebase');
                return true;
            }
            return false;
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Add a player to a team
        function addPlayer(team) {
            const nameInput = document.getElementById(`player-name-${team.toLowerCase()}`);
            const numberInput = document.getElementById(`player-number-${team.toLowerCase()}`);
            
            const name = nameInput.value.trim();
            const number = numberInput.value.trim();
            
            if (!name || !number) {
                alert('Please enter both name and number for the player');
                return;
            }
            
            // Find first empty slot
            const emptySlot = players[team].find(player => player.isEmpty);
            
            if (!emptySlot) {
                alert('No empty slots available. Maximum 16 players per team.');
                return;
            }
            
            // Update player data
            emptySlot.name = name;
            emptySlot.number = number;
            emptySlot.isEmpty = false;
            
            // Clear inputs
            nameInput.value = '';
            numberInput.value = '';
            
            // Re-render table
            renderTeamTable(team);
            setupCellClickHandlers();
            
            // Auto-save if online
            if (gameState.isOnline) {
                saveGameState();
            }
        }

        // Setup click handlers for all stat cells
        function setupCellClickHandlers() {
            // Initialize context menu
            contextMenu.element = document.getElementById('context-menu');
            document.getElementById('increment-btn').addEventListener('click', handleIncrement);
            document.getElementById('decrement-btn').addEventListener('click', handleDecrement);
            document.getElementById('reset-btn').addEventListener('click', handleReset);

            // Close context menu when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (e.target.className !== 'stat-cell' && !contextMenu.element.contains(e.target)) {
                    contextMenu.element.style.display = 'none';
                }
            });

            // Prevent default context menu
            document.addEventListener('contextmenu', (e) => {
                if (e.target.className === 'stat-cell') {
                    e.preventDefault();
                }
            });

            // Add click handlers to all stat cells
            document.querySelectorAll('.stat-cell').forEach(cell => {
                // Left click - increment
                cell.addEventListener('click', (e) => {
                    if (e.button === 0) { // Left click only
                        handleCellClick(cell, 1);
                    }
                });

                // Right click - context menu
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(cell, e);
                });

                // Touch devices - long press for context menu
                let pressTimer;
                cell.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        showContextMenu(cell, e);
                    }, 500); // 500ms for long press
                });

                cell.addEventListener('touchend', (e) => {
                    clearTimeout(pressTimer);
                });

                cell.addEventListener('touchmove', (e) => {
                    clearTimeout(pressTimer);
                });
            });
        }

        // Handle cell click (increment)
        function handleCellClick(cell, increment) {
            const team = cell.getAttribute('data-team');
            const playerId = parseInt(cell.getAttribute('data-player-id'));
            const stat = cell.getAttribute('data-stat');
            const player = players[team].find(p => p.id === playerId);

            if (!player || player.redCard || player.isEmpty) return; // Can't update stats for empty slots or players with red cards

            // Special handling for different stats
            switch(stat) {
                case 'twoMinutes':
                    const newTwoMinutes = player.twoMinutes + increment;
                    if (newTwoMinutes >= 0 && newTwoMinutes <= 3) {
                        player.twoMinutes = newTwoMinutes;
                        
                        // If giving a 2-minute suspension
                        if (increment > 0) {
                            player.isSuspended = true;
                            player.suspensionEndTime = gameState.seconds + 120; // 2 minutes
                        }
                        
                        // Check for red card (3 two-minute suspensions)
                        if (player.twoMinutes >= 3) {
                            player.redCard = true;
                            player.isSuspended = false;
                            document.querySelector(`[data-stat="redCard"][data-player-id="${playerId}"][data-team="${team}"]`).textContent = 'X';
                            document.querySelector(`#stats-body-${team.toLowerCase()} tr:nth-child(${playerId})`).classList.add('red-card');
                            alert(`Player ${player.name} (${player.number}) received a red card for 3 two-minute suspensions!`);
                        }
                        
                        renderTeamTable(team);
                        setupCellClickHandlers();
                    }
                    break;
                    
                case 'yellowCards':
                    const newYellowCards = player.yellowCards + increment;
                    if (newYellowCards >= 0 && newYellowCards <= 2) {
                        player.yellowCards = newYellowCards;
                        cell.textContent = player.yellowCards;
                        cell.classList.toggle('yellow-card', player.yellowCards > 0);
                        
                        // Check if player already has 2 yellow cards
                        if (player.yellowCards >= 2) {
                            alert(`Player ${player.name} (${player.number}) has received 2 yellow cards!`);
                        }
                    }
                    break;
                    
                case 'redCard':
                    if (increment > 0) {
                        player.redCard = !player.redCard;
                        player.isSuspended = false;
                        cell.textContent = player.redCard ? 'X' : '';
                        document.querySelector(`#stats-body-${team.toLowerCase()} tr:nth-child(${playerId})`).classList.toggle('red-card', player.redCard);
                    }
                    break;
                    
                default:
                    const newValue = player[stat] + increment;
                    if (newValue >= 0) {
                        // Update the score if it's a goal
                        if (stat === 'goals') {
                            updateScores(team, increment);
                        }
                        
                        player[stat] = newValue;
                        cell.textContent = player[stat];
                    }
                    break;
            }
            
            // Auto-save if online
            if (gameState.isOnline) {
                saveGameState();
            }
        }

        // Update scores when a goal is scored
        function updateScores(team, increment) {
            gameState.totalScores[team] += increment;
            
            // Update the current period score
            if (gameState.period in gameState.periodScores) {
                gameState.periodScores[gameState.period][team] += increment;
            }
            
            // Update the score display for completed periods
            updatePeriodScoresDisplay();
        }

        // Update the displayed scores for each period
        function updatePeriodScoresDisplay() {
            for (const period in gameState.periodScores) {
                const scoreElement = document.getElementById(`period-${period.toLowerCase()}-score`);
                if (scoreElement) {
                    const scores = gameState.periodScores[period];
                    scoreElement.textContent = `${scores.A} / ${scores.B}`;
                }
            }
        }

        // Show context menu
        function showContextMenu(cell, event) {
            contextMenu.currentCell = cell;
            contextMenu.currentPlayer = {
                team: cell.getAttribute('data-team'),
                id: parseInt(cell.getAttribute('data-player-id')),
                stat: cell.getAttribute('data-stat')
            };
            
            // Position the context menu
            contextMenu.element.style.display = 'block';
            contextMenu.element.style.left = `${event.clientX}px`;
            contextMenu.element.style.top = `${event.clientY}px`;
            
            // Prevent default for touch events
            if (event.type === 'touchstart') {
                event.preventDefault();
            }
        }

        // Handle increment from context menu
        function handleIncrement() {
            handleCellClick(contextMenu.currentCell, 1);
            contextMenu.element.style.display = 'none';
        }

        // Handle decrement from context menu
        function handleDecrement() {
            handleCellClick(contextMenu.currentCell, -1);
            contextMenu.element.style.display = 'none';
        }

        // Handle reset from context menu
        function handleReset() {
            const player = players[contextMenu.currentPlayer.team].find(p => p.id === contextMenu.currentPlayer.id);
            const stat = contextMenu.currentPlayer.stat;
            
            if (player && !player.isEmpty) {
                // Special cases
                if (stat === 'redCard') {
                    player.redCard = false;
                    contextMenu.currentCell.textContent = '';
                    document.querySelector(`#stats-body-${contextMenu.currentPlayer.team.toLowerCase()} tr:nth-child(${contextMenu.currentPlayer.id})`).classList.remove('red-card');
                } else if (stat === 'twoMinutes') {
                    player.twoMinutes = 0;
                    player.isSuspended = false;
                    renderTeamTable(contextMenu.currentPlayer.team);
                    setupCellClickHandlers();
                } else {
                    // If it's a goal stat, update the scores
                    if (stat === 'goals' && player[stat] > 0) {
                        updateScores(contextMenu.currentPlayer.team, -player[stat]);
                    }
                    
                    player[stat] = 0;
                    contextMenu.currentCell.textContent = '0';
                    
                    // Clear yellow card styling if resetting yellow cards
                    if (stat === 'yellowCards') {
                        contextMenu.currentCell.classList.remove('yellow-card');
                    }
                }
            }
            
            contextMenu.element.style.display = 'none';
            
            // Auto-save if online
            if (gameState.isOnline) {
                saveGameState();
            }
        }

        // Call a timeout for a team
        function callTimeout(team) {
            if (gameState.timeouts[team] <= 0) {
                alert(`Team ${team} has no timeouts remaining!`);
                return;
            }

            if (gameState.isTimeoutActive) {
                alert('A timeout is already active!');
                return;
            }

            // Pause the game
            if (!gameState.isPaused) {
                togglePause();
            }

            // Start the timeout
            gameState.isTimeoutActive = true;
            gameState.timeoutTeam = team;
            gameState.timeouts[team]--;
            gameState.timeoutStartTime = gameState.seconds;
            gameState.timeoutEndTime = gameState.seconds + 60; // 60 seconds = 1 minute

            // Update UI
            document.getElementById(`timeout-count-${team}`).textContent = gameState.timeouts[team];
            document.getElementById(`timeout-button-${team}`).classList.add('timeout-disabled');
            document.getElementById(`timeout-button-${team === 'A' ? 'B' : 'A'}`).classList.add('timeout-disabled');
            document.getElementById(`timeout-button-${team}`).classList.add('timeout-active');

            // Start timeout timer
            gameState.timeoutTimer = setInterval(updateTimeoutTimer, 1000);
            updateTimeoutTimer();

            alert(`Team ${team} called a timeout (1 minute). Remaining timeouts: ${gameState.timeouts[team]}`);
            
            // Auto-save if online
            if (gameState.isOnline) {
                saveGameState();
            }
        }

        // Update timeout timer display
        function updateTimeoutTimer() {
            if (!gameState.isTimeoutActive) return;

            const remainingSeconds = gameState.timeoutEndTime - gameState.seconds;
            if (remainingSeconds <= 0) {
                endTimeout();
                return;
            }

            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            document.getElementById(`timeout-timer-${gameState.timeoutTeam}`).textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // End the current timeout
        function endTimeout() {
            if (!gameState.isTimeoutActive) return;

            clearInterval(gameState.timeoutTimer);
            gameState.isTimeoutActive = false;
            
            // Reset UI
            document.getElementById(`timeout-button-A`).classList.remove('timeout-disabled', 'timeout-active');
            document.getElementById(`timeout-button-B`).classList.remove('timeout-disabled', 'timeout-active');
            document.getElementById(`timeout-timer-A`).textContent = '';
            document.getElementById(`timeout-timer-B`).textContent = '';
            
            // If team has no timeouts left, disable their button
            if (gameState.timeouts['A'] <= 0) {
                document.getElementById(`timeout-button-A`).classList.add('timeout-disabled');
            }
            if (gameState.timeouts['B'] <= 0) {
                document.getElementById(`timeout-button-B`).classList.add('timeout-disabled');
            }

            // Resume the game if it was paused for the timeout
            if (gameState.isPaused) {
                togglePause();
            }

            alert(`Timeout for Team ${gameState.timeoutTeam} has ended. Game resumes.`);
            gameState.timeoutTeam = null;
            
            // Auto-save if online
            if (gameState.isOnline) {
                saveGameState();
            }
        }

        // Update game time display
        function updateTimeDisplay() {
            if (gameState.isPaused) return;

            gameState.seconds++;
            
            const periodSeconds = getPeriodSeconds();
            const minutes = Math.floor(periodSeconds / 60);
            const seconds = periodSeconds % 60;
            
            document.getElementById('match-time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update period based on time
            updatePeriod();
            
            // Check for ended suspensions
            checkSuspensions();
            
            // Update timeout timer if active
            if (gameState.isTimeoutActive) {
                updateTimeoutTimer();
            }
        }
        
        // Check for ended suspensions
        function checkSuspensions() {
            for (const team of ['A', 'B']) {
                for (const player of players[team]) {
                    if (player.isSuspended && gameState.seconds >= player.suspensionEndTime) {
                        player.isSuspended = false;
                        renderTeamTable(team);
                        setupCellClickHandlers();
                    }
                }
            }
        }
        
        // Get seconds in current period
        function getPeriodSeconds() {
            let periodStart = 0;
            
            if (gameState.period === '2H') {
                periodStart = gameState.periodDurations['1H'];
            } else if (gameState.period === 'ET1') {
                periodStart = gameState.periodDurations['1H'] + gameState.periodDurations['2H'];
            } else if (gameState.period === 'ET2') {
                periodStart = gameState.periodDurations['1H'] + gameState.periodDurations['2H'] + gameState.periodDurations['ET1'];
            }
            
            return gameState.seconds - periodStart;
        }
        
        // Update current period
        function updatePeriod() {
            const prevPeriod = gameState.period;
            
            if (gameState.seconds < gameState.periodDurations['1H']) {
                gameState.period = '1H';
            } else if (gameState.seconds < gameState.periodDurations['1H'] + gameState.periodDurations['2H']) {
                gameState.period = '2H';
                // If we just transitioned to 2H, record 1H scores
                if (prevPeriod === '1H') {
                    updatePeriodScoresDisplay();
                }
            } else if (gameState.seconds < gameState.periodDurations['1H'] + gameState.periodDurations['2H'] + gameState.periodDurations['ET1']) {
                gameState.period = 'ET1';
                // If we just transitioned to ET1, record 2H scores
                if (prevPeriod === '2H') {
                    updatePeriodScoresDisplay();
                }
            } else {
                gameState.period = 'ET2';
                // If we just transitioned to ET2, record ET1 scores
                if (prevPeriod === 'ET1') {
                    updatePeriodScoresDisplay();
                }
            }
            
            updatePeriodHighlight();
        }

        // Highlight current period
        function updatePeriodHighlight() {
            document.querySelectorAll('.time-markers div').forEach(el => {
                el.classList.remove('active-period');
            });
            document.getElementById(`period-${gameState.period}`).classList.add('active-period');
            document.getElementById('current-period').textContent = gameState.period;
        }
        
        // Update suspension button state
        function updateSuspensionButton() {
            const btn = document.getElementById('toggle-suspension');
            if (gameState.isTwoMinuteSuspension) {
                btn.textContent = `2' Suspension (${gameState.suspensionTeam})`;
                btn.classList.add('suspension-active');
            } else {
                btn.textContent = "2' Suspension Inactive";
                btn.classList.remove('suspension-active');
            }
        }
        
        // Initialize game timer
        function startTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            gameState.timerInterval = setInterval(updateTimeDisplay, 1000);
        }
        
        // Pause or resume the game
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            const pauseBtn = document.getElementById('pause-btn');
            
            if (gameState.isPaused) {
                pauseBtn.textContent = '▶ Resume';
                if (gameState.timerInterval) {
                    clearInterval(gameState.timerInterval);
                }
            } else {
                pauseBtn.textContent = '⏸ Pause';
                startTimer();
            }
            
            // Auto-save if online
            if (gameState.isOnline) {
                saveGameState();
            }
        }
        
        // Reset game time
        function resetTime() {
            if (confirm('Are you sure you want to reset the game time to 00:00?')) {
                gameState.seconds = 0;
                gameState.period = '1H';
                gameState.periodScores = {
                    '1H': { A: 0, B: 0 },
                    '2H': { A: 0, B: 0 },
                    'ET1': { A: 0, B: 0 },
                    'ET2': { A: 0, B: 0 }
                };
                gameState.totalScores = { A: 0, B: 0 };
                
                // Clear period scores display
                document.querySelectorAll('.period-score').forEach(el => {
                    el.textContent = '';
                });
                
                // Reset all player suspensions
                for (const team of ['A', 'B']) {
                    for (const player of players[team]) {
                        player.isSuspended = false;
                    }
                    renderTeamTable(team);
                }
                
                updateTimeDisplay();
                
                // Auto-save if online
                if (gameState.isOnline) {
                    saveGameState();
                }
            }
        }
        
        // Apply time configuration
        function applyTimeConfig() {
            const period1H = parseInt(document.getElementById('period-1h-duration').value) || 30;
            const period2H = parseInt(document.getElementById('period-2h-duration').value) || 30;
            const periodET1 = parseInt(document.getElementById('period-et1-duration').value) || 5;
            const periodET2 = parseInt(document.getElementById('period-et2-duration').value) || 5;
            
            gameState.periodDurations = {
                '1H': period1H * 60,
                '2H': period2H * 60,
                'ET1': periodET1 * 60,
                'ET2': periodET2 * 60
            };
            
            // Update the displayed period durations
            document.querySelectorAll('.period-duration').forEach((el, index) => {
                const durations = [period1H, period2H, periodET1, periodET2];
                el.textContent = durations[index];
            });
            
            alert(`Time configuration updated:\n1H: ${period1H} min\n2H: ${period2H} min\nET1: ${periodET1} min\nET2: ${periodET2} min`);
            
            // Auto-save if online
            if (gameState.isOnline) {
                saveGameState();
            }
        }
        
        // Setup editable referees
        function setupEditableReferees() {
            document.getElementById('referee1').addEventListener('input', function() {
                // Auto-save if online
                if (gameState.isOnline) {
                    saveGameState();
                }
            });
            
            document.getElementById('referee2').addEventListener('input', function() {
                // Auto-save if online
                if (gameState.isOnline) {
                    saveGameState();
                }
            });
        }
        
        // Setup official controls
        function setupOfficialControls() {
            document.querySelectorAll('.remove-official').forEach(btn => {
                btn.addEventListener('click', function() {
                    const team = this.getAttribute('data-team');
                    const index = parseInt(this.getAttribute('data-index'));
                    const nameCell = this.closest('tr').querySelector('.official-name');
                    
                    if (confirm(`Remove ${nameCell.textContent} from Team ${team} officials?`)) {
                        nameCell.textContent = '';
                        
                        // Auto-save if online
                        if (gameState.isOnline) {
                            saveGameState();
                        }
                    }
                });
            });
        }

        // Update auth UI
        function updateAuthUI(user) {
            const authStatus = document.getElementById('auth-status');
            const userEmail = document.getElementById('user-email');
            const loginForm = document.getElementById('login-form');
            const toggleBtn = document.getElementById('toggle-online-btn');

            if (gameState.isOnline && user) {
                authStatus.textContent = 'Online Mode';
                userEmail.style.display = '';
                userEmail.textContent = user.email;
                loginForm.style.display = '';
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = '';
                toggleBtn.textContent = 'Go Offline';
            } else if (gameState.isOnline && !user) {
                authStatus.textContent = 'Online Mode (Not logged in)';
                userEmail.style.display = 'none';
                loginForm.style.display = '';
                document.getElementById('login-btn').style.display = '';
                document.getElementById('logout-btn').style.display = 'none';
                toggleBtn.textContent = 'Go Offline';
            } else {
                authStatus.textContent = 'Offline Mode';
                userEmail.style.display = 'none';
                loginForm.style.display = 'none';
                toggleBtn.textContent = 'Go Online';
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Toggle suspension
            document.getElementById('toggle-suspension').addEventListener('click', function() {
                gameState.isTwoMinuteSuspension = !gameState.isTwoMinuteSuspension;
                if (gameState.isTwoMinuteSuspension) {
                    gameState.suspensionTeam = 'A'; // Default to Team A, can be changed
                    gameState.suspensionEndTime = gameState.seconds + 120; // 2 minutes
                } else {
                    gameState.suspensionTeam = null;
                }
                updateSuspensionButton();
                
                // Auto-save if online
                if (gameState.isOnline) {
                    saveGameState();
                }
            });
            
            // Timeout buttons
            document.getElementById('timeout-button-a').addEventListener('click', function() {
                callTimeout('A');
            });
            
            document.getElementById('timeout-button-b').addEventListener('click', function() {
                callTimeout('B');
            });
            
            // Add players
            document.getElementById('add-player-a').addEventListener('click', function() {
                addPlayer('A');
            });
            
            document.getElementById('add-player-b').addEventListener('click', function() {
                addPlayer('B');
            });
            
            // Pause button
            document.getElementById('pause-btn').addEventListener('click', togglePause);
            
            // Reset time button
            document.getElementById('reset-time-btn').addEventListener('click', resetTime);
            
            // Apply time configuration
            document.getElementById('apply-time-config').addEventListener('click', applyTimeConfig);
            
            // Online/offline toggle
            document.getElementById('toggle-online-btn').addEventListener('click', async function() {
                if (!gameState.isOnline) {
                    gameState.isOnline = true;
                    const user = await firebaseService.getCurrentUser();
                    updateAuthUI(user);
                    if (user) {
                        // Try to load from Firebase
                        const loaded = await loadGameState();
                        if (!loaded) {
                            await saveGameState();
                        }
                    }
                } else {
                    gameState.isOnline = false;
                    updateAuthUI(null);
                }
            });
            
            // Login button
            document.getElementById('login-btn').addEventListener('click', async function() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                if (!email || !password) {
                    alert('Please enter both email and password');
                    return;
                }
                
                const success = await firebaseService.signIn(email, password);
                if (success) {
                    const user = await firebaseService.getCurrentUser();
                    updateAuthUI(user);
                    await loadGameState();
                } else {
                    alert('Login failed. Please check your credentials.');
                }
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', async function() {
                await firebaseService.signOut();
                updateAuthUI(null);
            });
        }

        // Initialize the application
        function initialize() {
            initializeTables();
            setupEventListeners();
            startTimer();
            updatePeriodHighlight();
            updateSuspensionButton();
            applyTimeConfig();
            
            // Initialize auth state
            auth.onAuthStateChanged(async function(user) {
                updateAuthUI(user);
                if (gameState.isOnline && user) {
                    await loadGameState();
                }
            });
            
            // Auto-save to Firebase every 30 seconds if online
            setInterval(() => {
                if (gameState.isOnline) {
                    saveGameState();
                }
            }, 30000);
            
            // Save before page unload
            window.addEventListener('beforeunload', (e) => {
                if (gameState.isOnline) {
                    saveGameState();
                }
            });
        }
        
        // Start the application
        initialize();
    });
    </script>
</body>
</html>